# Custom Renderers

Truthound Data Docs는 커스텀 렌더러를 통해 확장할 수 있습니다.

## 템플릿 렌더러

### CustomRenderer (Base Class)

모든 커스텀 렌더러의 기본 클래스입니다.

```python
from truthound.datadocs.renderers.custom import CustomRenderer

class MyRenderer(CustomRenderer):
    def __init__(self, name: str | None = None):
        super().__init__(name=name or "MyRenderer")

    def _do_render(self, ctx, theme):
        context = self._build_context(ctx, theme)
        return f"<html><body>{context['title']}</body></html>"
```

### StringTemplateRenderer

`{key}` 플레이스홀더를 사용하는 문자열 템플릿 렌더러입니다.

```python
from truthound.datadocs.renderers.custom import StringTemplateRenderer

renderer = StringTemplateRenderer(
    template="""
    <html>
        <head><title>{title}</title></head>
        <body>
            <h1>{title}</h1>
            <p>{subtitle}</p>
        </body>
    </html>
    """,
    name="MyStringRenderer",
    safe_mode=True,  # HTML 이스케이프 활성화
)
```

### FileTemplateRenderer

파일에서 템플릿을 로드하는 렌더러입니다.

```python
from pathlib import Path
from truthound.datadocs.renderers.custom import FileTemplateRenderer

renderer = FileTemplateRenderer(
    template_path=Path("./templates/report.html.j2"),
    engine="auto",  # "jinja2", "string", 또는 "auto"
    name="MyFileRenderer",
    encoding="utf-8",
)
```

**엔진 자동 감지:**
- `.j2`, `.jinja`, `.jinja2` 확장자 → Jinja2
- `.html`에 `{{` 또는 `{%` 포함 → Jinja2
- 그 외 → 문자열 포맷팅

### CallableRenderer

임의의 함수를 렌더러로 사용합니다.

```python
from truthound.datadocs.renderers.custom import CallableRenderer

def my_render_func(ctx, theme):
    return f"""
    <html>
        <head><title>{ctx.title}</title></head>
        <body>
            <h1>{ctx.title}</h1>
            <p>Rows: {ctx.data.metadata.get('row_count', 0)}</p>
        </body>
    </html>
    """

renderer = CallableRenderer(
    render_func=my_render_func,
    name="MyCallableRenderer",
)
```

## 템플릿 컨텍스트

모든 렌더러는 `_build_context()` 메서드를 통해 템플릿 컨텍스트를 생성합니다.

### 기본 컨텍스트 변수

```python
context = {
    "title": ctx.title,           # 리포트 제목
    "subtitle": ctx.subtitle,     # 부제목
    "locale": ctx.locale,         # 로케일
    "theme": ctx.theme,           # 테마 이름
    "theme_css": theme.get_css(), # 테마 CSS
    "metadata": data.metadata,    # 프로파일 메타데이터
    "sections": data.sections,    # 섹션 데이터
    "alerts": data.alerts,        # 경고 목록
    "recommendations": data.recommendations,  # 추천 목록
    "charts": data.charts,        # 차트 데이터
    "tables": data.tables,        # 테이블 데이터
    "raw": data.raw,              # 원본 프로파일 데이터
    "options": ctx.options,       # 추가 옵션
}
```

### 커스텀 컨텍스트 빌더

```python
from truthound.datadocs.renderers.custom import CustomRenderer

def my_context_builder(ctx, theme):
    return {
        "title": ctx.title,
        "quality_score": ctx.data.raw.get("quality_score", 0),
        "custom_data": "Hello World",
    }

renderer = CustomRenderer(
    name="MyRenderer",
    context_builder=my_context_builder,
)
```

## Jinja2 템플릿 예시

### 기본 리포트 템플릿

```jinja2
{# templates/report.html.j2 #}
<!DOCTYPE html>
<html lang="{{ locale }}">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <style>{{ theme_css }}</style>
</head>
<body>
    <header>
        <h1>{{ title }}</h1>
        {% if subtitle %}
        <p class="subtitle">{{ subtitle }}</p>
        {% endif %}
    </header>

    <main>
        {# Overview #}
        <section id="overview">
            <h2>Overview</h2>
            <div class="metrics">
                <div class="metric">
                    <span class="value">{{ metadata.row_count | default(0) | number }}</span>
                    <span class="label">Rows</span>
                </div>
                <div class="metric">
                    <span class="value">{{ metadata.column_count | default(0) }}</span>
                    <span class="label">Columns</span>
                </div>
            </div>
        </section>

        {# Alerts #}
        {% if alerts %}
        <section id="alerts">
            <h2>Alerts</h2>
            {% for alert in alerts %}
            <div class="alert alert-{{ alert.severity }}">
                <strong>{{ alert.title }}</strong>
                <p>{{ alert.message }}</p>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        {# Recommendations #}
        {% if recommendations %}
        <section id="recommendations">
            <h2>Recommendations</h2>
            <ul>
            {% for rec in recommendations %}
                <li>{{ rec }}</li>
            {% endfor %}
            </ul>
        </section>
        {% endif %}
    </main>

    <footer>
        <p>Generated by Truthound</p>
    </footer>
</body>
</html>
```

### 사용법

```python
from pathlib import Path
from truthound.datadocs.renderers.custom import FileTemplateRenderer
from truthound.datadocs.engine.context import ReportContext, ReportData

# 렌더러 생성
renderer = FileTemplateRenderer(
    template_path=Path("./templates/report.html.j2"),
    engine="jinja2",
)

# 컨텍스트 생성
ctx = ReportContext(
    title="My Report",
    subtitle="Q4 Analysis",
    locale="en",
    theme="professional",
    data=ReportData(
        metadata={"row_count": 1000, "column_count": 15},
        raw=profile_dict,
    ),
)

# 렌더링
html = renderer.render(ctx, theme=None)
```

## 차트 렌더러 확장

### 커스텀 차트 렌더러 등록

```python
from truthound.datadocs import (
    BaseChartRenderer,
    ChartSpec,
    ChartLibrary,
    register_chart_renderer,
)

# NOTE: ChartLibrary enum은 현재 APEXCHARTS, SVG만 지원합니다.
# 새로운 라이브러리를 추가하려면 먼저 ChartLibrary enum에 추가해야 합니다.
# 아래는 커스텀 렌더러 등록 예시입니다:

@register_chart_renderer(ChartLibrary.APEXCHARTS)
class CustomApexChartsRenderer(BaseChartRenderer):
    """커스텀 ApexCharts 기반 차트 렌더러."""

    library = ChartLibrary.APEXCHARTS

    def render(self, spec: ChartSpec) -> str:
        import json

        chart_id = f"chart-{id(spec)}"
        option = {
            "title": {"text": spec.title},
            "xAxis": {"data": spec.labels},
            "yAxis": {},
            "series": [{"type": "bar", "data": spec.values}],
        }

        return f"""
        <div id="{chart_id}" style="height: {spec.height}px;"></div>
        <script>
            var chart = echarts.init(document.getElementById('{chart_id}'));
            chart.setOption({json.dumps(option)});
        </script>
        """

    def get_dependencies(self) -> list[str]:
        return ["https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"]
```

### 사용

```python
from truthound.datadocs import get_chart_renderer, ChartLibrary

renderer = get_chart_renderer(ChartLibrary.APEXCHARTS)
html = renderer.render(chart_spec)
```

## 섹션 렌더러 확장

### 커스텀 섹션 렌더러 등록

```python
from truthound.datadocs import (
    BaseSectionRenderer,
    SectionSpec,
    SectionType,
    register_section_renderer,
)

# NOTE: SectionType enum을 사용해야 합니다.
# 커스텀 섹션을 추가하려면 SectionType.CUSTOM을 사용하세요.

@register_section_renderer(SectionType.CUSTOM)
class KPIDashboardSection(BaseSectionRenderer):
    """KPI 대시보드 섹션."""

    section_type = SectionType.CUSTOM

    def render(self, spec: SectionSpec, chart_renderer, theme_config) -> str:
        metrics = spec.metrics
        return f"""
        <section class="kpi-dashboard">
            <h2>{spec.title}</h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-value">{metrics.get('quality_score', 0)}%</span>
                    <span class="kpi-label">Quality Score</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-value">{metrics.get('completeness', 0):.1f}%</span>
                    <span class="kpi-label">Completeness</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-value">{metrics.get('uniqueness', 0):.1f}%</span>
                    <span class="kpi-label">Uniqueness</span>
                </div>
            </div>
        </section>
        """
```

### ReportConfig에서 사용

```python
from truthound.datadocs import ReportConfig, SectionType

config = ReportConfig(
    sections=[
        "kpi_dashboard",       # 커스텀 섹션 (문자열)
        SectionType.OVERVIEW,
        SectionType.COLUMNS,
    ]
)
```

## 렌더러 레지스트리

### 등록된 렌더러 조회

```python
from truthound.datadocs import renderer_registry

# 등록된 차트 렌더러 목록
chart_renderers = renderer_registry.list_chart_renderers()
# ['apexcharts', 'svg', 'echarts']

# 등록된 섹션 렌더러 목록
section_renderers = renderer_registry.list_section_renderers()
# ['overview', 'columns', 'quality', ..., 'kpi_dashboard']
```

### 렌더러 가져오기

```python
from truthound.datadocs import (
    get_chart_renderer,
    get_section_renderer,
)

# 이름으로 렌더러 가져오기
chart_renderer = get_chart_renderer("apexcharts")
section_renderer = get_section_renderer("overview")
```

### 렌더러 등록 해제

```python
from truthound.datadocs import renderer_registry

# 차트 렌더러 등록 해제
renderer_registry.unregister_chart("echarts")

# 섹션 렌더러 등록 해제
renderer_registry.unregister_section("kpi_dashboard")
```

## API Reference

### BaseRenderer

```python
class BaseRenderer(ABC):
    def __init__(self, name: str | None = None) -> None:
        self._name = name or self.__class__.__name__

    @property
    def name(self) -> str:
        return self._name

    def render(self, ctx: "ReportContext", theme: "Theme | None") -> str:
        return self._do_render(ctx, theme)

    @abstractmethod
    def _do_render(self, ctx: "ReportContext", theme: "Theme | None") -> str:
        ...
```

### CustomRenderer

```python
class CustomRenderer(BaseRenderer):
    def __init__(
        self,
        name: str | None = None,
        context_builder: Callable[[ReportContext, Theme | None], dict[str, Any]] | None = None,
    ) -> None:
        ...

    def _build_context(self, ctx: ReportContext, theme: Theme | None) -> dict[str, Any]:
        ...
```

### StringTemplateRenderer

```python
class StringTemplateRenderer(CustomRenderer):
    def __init__(
        self,
        template: str,
        name: str | None = None,
        safe_mode: bool = True,  # HTML 이스케이프
    ) -> None:
        ...
```

### FileTemplateRenderer

```python
class FileTemplateRenderer(CustomRenderer):
    def __init__(
        self,
        template_path: Path | str,
        engine: str = "auto",  # "jinja2", "string", "auto"
        name: str | None = None,
        encoding: str = "utf-8",
    ) -> None:
        ...
```

### CallableRenderer

```python
class CallableRenderer(CustomRenderer):
    def __init__(
        self,
        render_func: Callable[[ReportContext, Theme | None], str],
        name: str | None = None,
    ) -> None:
        ...
```

## See Also

- [HTML Reports](html-reports.md) - HTML 리포트 생성
- [Charts](charts.md) - 차트 렌더링
- [Sections](sections.md) - 섹션 구성
- [Themes](themes.md) - 테마 커스터마이징
